–7
KC:\FIAP\GitAct\FiapChallengeGrupo32\TechChallangeCadastroCotatos\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
var 
configuration 
= 
new  
ConfigurationBuilder ,
(, -
)- .
. 
AddJsonFile 
( 
$str #
)# $
. 
Build 

(
 
) 
; 
var 
jwtKey 

= 
Utils 
. 
CHAVE_TOKEN 
; 
builder 
. 
Services 
. 
AddAuthentication "
(" #
JwtBearerDefaults# 4
.4 5 
AuthenticationScheme5 I
)I J
. 
AddJwtBearer 
( 
options 
=> 
{ 
options 
. %
TokenValidationParameters &
=' (
new) ,%
TokenValidationParameters- F
{ 
ValidateIssuer	 
= 
false 
,  
ValidateAudience	 
= 
false !
,! "
ValidateLifetime	 
= 
true  
,  !$
ValidateIssuerSigningKey	 !
=" #
true$ (
,( )
IssuerSigningKey	 
= 
new  
SymmetricSecurityKey  4
(4 5
Encoding5 =
.= >
UTF8> B
.B C
GetBytesC K
(K L
jwtKeyL R
)R S
)S T
} 
; 
} 
) 
; 
builder   
.   
Services   
.   
AddControllers   
(    
)    !
.!! 
AddJsonOptions!! 
(!! 
opts!!  
=>!!! #
opts!!$ (
.!!( )!
JsonSerializerOptions!!) >
.!!> ? 
PropertyNamingPolicy!!? S
=!!T U
null!!V Z
)!!Z [
;!![ \
builder## 
.## 
Services## 
.## #
AddEndpointsApiExplorer## (
(##( )
)##) *
;##* +
builder$$ 
.$$ 
Services$$ 
.$$ 
AddSwaggerGen$$ 
($$ 
setup$$ $
=>$$% '
{%% 
var&& 
xmlFile&& 
=&& 
$"&& 
{&& 
Assembly&& 
.&&  
GetExecutingAssembly&& 2
(&&2 3
)&&3 4
.&&4 5
GetName&&5 <
(&&< =
)&&= >
.&&> ?
Name&&? C
}&&C D
$str&&D H
"&&H I
;&&I J
var'' 
xmlPath'' 
='' 
Path'' 
.'' 
Combine'' 
('' 

AppContext'' )
.'') *
BaseDirectory''* 7
,''7 8
xmlFile''9 @
)''@ A
;''A B
setup(( 	
.((	 

IncludeXmlComments((
 
((( 
xmlPath(( $
)(($ %
;((% &
var** 
jwtSecurityScheme** 
=** 
new** !
OpenApiSecurityScheme**  5
{++ 
BearerFormat,, 
=,, 
$str,, 
,,, 
Name-- 
=-- 
$str-- !
,--! "
In.. 

=.. 
ParameterLocation.. 
... 
Header.. %
,..% &
Type// 
=// 
SecuritySchemeType// !
.//! "
Http//" &
,//& '
Scheme00 
=00 
JwtBearerDefaults00 "
.00" # 
AuthenticationScheme00# 7
,007 8
Description11 
=11 
$str11 {
,11{ |
	Reference22 
=22 
new22 
OpenApiReference22 (
{33 	
Id44 
=44 
JwtBearerDefaults44 "
.44" # 
AuthenticationScheme44# 7
,447 8
Type55 
=55 
ReferenceType55  
.55  !
SecurityScheme55! /
}66 	
}77 
;77 
setup88 	
.88	 
!
AddSecurityDefinition88
 
(88  
jwtSecurityScheme88  1
.881 2
	Reference882 ;
.88; <
Id88< >
,88> ?
jwtSecurityScheme88@ Q
)88Q R
;88R S
setup99 	
.99	 
"
AddSecurityRequirement99
  
(99  !
new99! $&
OpenApiSecurityRequirement99% ?
{:: 
{;; 	
jwtSecurityScheme;;
 
,;; 
Array;; "
.;;" #
Empty;;# (
<;;( )
string;;) /
>;;/ 0
(;;0 1
);;1 2
};;3 4
}<< 
)<< 
;<< 
}>> 
)>> 
;>> 
builder@@ 
.@@ 
Services@@ 
.@@ 
AddDbContext@@ 
<@@  
ApplicationDbContext@@ 2
>@@2 3
(@@3 4
options@@4 ;
=>@@< >
{AA 
optionsBB 
.BB 
UseSqlServerBB 
(BB 
configurationBB &
.BB& '
GetConnectionStringBB' :
(BB: ;
$strBB; N
)BBN O
)BBO P
;BBP Q
}CC 
,CC 
ServiceLifetimeCC 
.CC 
ScopedCC 
)CC 
;CC 
builderEE 
.EE 
ServicesEE 
.EE 
	AddScopedEE 
<EE 
IContatoRepositoryEE -
,EE- .
ContatoRepositoryEE/ @
>EE@ A
(EEA B
)EEB C
;EEC D
varGG 
appGG 
=GG 	
builderGG
 
.GG 
BuildGG 
(GG 
)GG 
;GG 
ifJJ 
(JJ 
appJJ 
.JJ 
EnvironmentJJ 
.JJ 
IsDevelopmentJJ !
(JJ! "
)JJ" #
)JJ# $
{KK 
appLL 
.LL 

UseSwaggerLL 
(LL 
)LL 
;LL 
appMM 
.MM 
UseSwaggerUIMM 
(MM 
)MM 
;MM 
}NN 
appPP 
.PP 
UseLogMiddlewarePP 
(PP 
)PP 
;PP 
appQQ 
.QQ 
UseHttpsRedirectionQQ 
(QQ 
)QQ 
;QQ 
appRR 
.RR 
UseAuthenticationRR 
(RR 
)RR 
;RR 
appSS 
.SS 
UseAuthorizationSS 
(SS 
)SS 
;SS 
appTT 
.TT 
MapControllersTT 
(TT 
)TT 
;TT 
appVV 
.VV 
RunVV 
(VV 
)VV 	
;VV	 
£
]C:\FIAP\GitAct\FiapChallengeGrupo32\TechChallangeCadastroCotatos\Middlewares\LogMiddleware.cs
	namespace 	,
 TechChallangeCadastroContatosAPI
 *
.* +
Middlewares+ 6
{ 
public		 

class		 
LogMiddleware		 
{

 
private 
readonly 
RequestDelegate (
_next) .
;. /
public 
LogMiddleware 
( 
RequestDelegate ,
next- 1
)1 2
{ 	
_next 
= 
next 
; 
} 	
public 
async 
Task 
Invoke  
(  !
HttpContext! ,
httpContext- 8
)8 9
{ 	
var 
request 
= 
httpContext %
.% &
Request& -
;- .
if 
( 
request 
. 
ContentLength %
>& '
$num( )
)) *
{ 
request 
. 
EnableBuffering '
(' (
)( )
;) *
var 
buffer 
= 
new  
byte! %
[% &
Convert& -
.- .
ToInt32. 5
(5 6
request6 =
.= >
ContentLength> K
)K L
]L M
;M N
await 
request 
. 
Body "
." #
	ReadAsync# ,
(, -
buffer- 3
)3 4
;4 5
string 
requestContent %
=& '
Encoding( 0
.0 1
UTF81 5
.5 6
	GetString6 ?
(? @
buffer@ F
)F G
;G H
Debug   
.   
	WriteLine   
(    
requestContent    .
)  . /
;  / 0
request!! 
.!! 
Body!! 
.!! 
Position!! %
=!!& '
$num!!( )
;!!) *
}"" 
await## 
_next## 
(## 
httpContext## #
)### $
;##$ %
}$$ 	
}%% 
public'' 

static'' 
class'' #
LogMiddlewareExtensions'' /
{(( 
public)) 
static)) 
IApplicationBuilder)) )
UseLogMiddleware))* :
()): ;
this)); ?
IApplicationBuilder))@ S
builder))T [
)))[ \
{** 	
return++ 
builder++ 
.++ 
UseMiddleware++ (
<++( )
LogMiddleware++) 6
>++6 7
(++7 8
)++8 9
;++9 :
},, 	
}-- 
}.. ¤
_C:\FIAP\GitAct\FiapChallengeGrupo32\TechChallangeCadastroCotatos\Controllers\LoginController.cs
	namespace 	,
 TechChallangeCadastroContatosAPI
 *
.* +
Controllers+ 6
{		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
ApiController 
] 
public 

class 
LoginController  
:! "
ControllerBase# 1
{ 
[ 	
HttpPost	 
] 
public 
IActionResult 
Post !
(! "
[" #
FromBody# +
]+ ,

LoginInput- 7

loginInput8 B
)B C
{ 	
if 
( 

ModelState 
. 
IsValid "
)" #
{ 
if 
( 

loginInput 
. 
Usuario &
==' )
$str* 8
&&9 ;

loginInput< F
.F G
SenhaG L
==M O
$strP \
)\ ]
{ 
var 
securityKey #
=$ %
new& ) 
SymmetricSecurityKey* >
(> ?
Encoding? G
.G H
UTF8H L
.L M
GetBytesM U
(U V
UtilsV [
.[ \
CHAVE_TOKEN\ g
)g h
)h i
;i j
var 
credentials #
=$ %
new& )
SigningCredentials* <
(< =
securityKey= H
,H I
SecurityAlgorithmsJ \
.\ ]

HmacSha256] g
)g h
;h i
var 
Sectoken  
=! "
new# &
JwtSecurityToken' 7
(7 8
null8 <
,< =
null 
, 
null 
, 
expires   
:   
DateTime   '
.  ' (
Now  ( +
.  + ,

AddMinutes  , 6
(  6 7
$num  7 :
)  : ;
,  ; <
signingCredentials!! (
:!!( )
credentials!!* 5
)!!5 6
;!!6 7
var## 
token## 
=## 
new##  ##
JwtSecurityTokenHandler##$ ;
(##; <
)##< =
.##= >

WriteToken##> H
(##H I
Sectoken##I Q
)##Q R
;##R S
return%% 
Ok%% 
(%% 
token%% #
)%%# $
;%%$ %
}&& 
else'' 
{(( 
return)) 
Unauthorized)) '
())' (
$str))( E
)))E F
;))F G
}** 
}++ 
else,, 
{-- 
return.. 

BadRequest.. !
(..! "

ModelState.." ,
).., -
;..- .
}// 
}00 	
}11 
}22 È@
aC:\FIAP\GitAct\FiapChallengeGrupo32\TechChallangeCadastroCotatos\Controllers\ContatoController.cs
	namespace 	,
 TechChallangeCadastroContatosAPI
 *
.* +
Controllers+ 6
{ 
[		 
ApiController		 
]		 
[

 
Route

 

(


 
$str

 
)

 
]

 
public 

class 
ContatoController "
:# $
ControllerBase% 3
{ 
private 
readonly 
IContatoRepository +
_contatoRepository, >
;> ?
public 
ContatoController  
(  !
IContatoRepository! 3
contatoRepository4 E
)E F
{ 	
_contatoRepository 
=  
contatoRepository! 2
;2 3
} 	
[ 	
	Authorize	 
] 
[ 	
HttpGet	 
] 
public 
IActionResult 
Get  
(  !
)! "
{ 	
try   
{!! 
return"" 
Ok"" 
("" 
_contatoRepository"" ,
."", -

ObterTodos""- 7
(""7 8
)""8 9
)""9 :
;"": ;
}## 
catch$$ 
($$ 
	Exception$$ 
e$$ 
)$$ 
{%% 
return&& 

BadRequest&& !
(&&! "
e&&" #
)&&# $
;&&$ %
}'' 
})) 	
[33 	
	Authorize33	 
]33 
[44 	
HttpGet44	 
(44 
$str44 !
)44! "
]44" #
public55 
IActionResult55 
Get55  
(55  !
[55! "
	FromRoute55" +
]55+ ,
int55- 0
id551 3
)553 4
{66 	
try88 
{99 
return:: 
Ok:: 
(:: 
_contatoRepository:: ,
.::, -

ObterPorId::- 7
(::7 8
id::8 :
)::: ;
)::; <
;::< =
};; 
catch<< 
(<< 
	Exception<< 
e<< 
)<< 
{== 
return>> 

BadRequest>> !
(>>! "
e>>" #
)>># $
;>>$ %
}?? 
}AA 	
[KK 	
	AuthorizeKK	 
]KK 
[LL 	
HttpGetLL	 
(LL 
$strLL &
)LL& '
]LL' (
publicMM 
IActionResultMM 
	GetPorDDDMM &
(MM& '
[MM' (
	FromRouteMM( 1
]MM1 2
intMM3 6
dddMM7 :
)MM: ;
{NN 	
tryPP 
{QQ 
returnRR 
OkRR 
(RR 
_contatoRepositoryRR ,
.RR, -
ObterPorDDDRR- 8
(RR8 9
dddRR9 <
)RR< =
)RR= >
;RR> ?
}SS 
catchTT 
(TT 
	ExceptionTT 
eTT 
)TT 
{UU 
returnVV 

BadRequestVV !
(VV! "
eVV" #
)VV# $
;VV$ %
}WW 
}YY 	
[oo 	
	Authorizeoo	 
]oo 
[pp 	
HttpPostpp	 
]pp 
publicqq 
IActionResultqq 
Postqq !
(qq! "
[qq" #
FromBodyqq# +
]qq+ ,
ContatoInputqq- 9
inputqq: ?
)qq? @
{rr 	
tryss 
{tt 
ifuu 
(uu 

ModelStateuu 
.uu 
IsValiduu &
)uu& '
{vv 
varww 
contatoww 
=ww  !
newww" %
Contatoww& -
(ww- .
)ww. /
{xx 
Nomeyy 
=yy 
inputyy $
.yy$ %
Nomeyy% )
,yy) *
DDDzz 
=zz 
inputzz #
.zz# $
DDDzz$ '
,zz' (
Telefone{{  
={{! "
Convert{{# *
.{{* +
ToInt32{{+ 2
({{2 3
input{{3 8
.{{8 9
Telefone{{9 A
){{A B
,{{B C
Email|| 
=|| 
input||  %
.||% &
Email||& +
,||+ ,
}}} 
;}} 
_contatoRepository~~ &
.~~& '
	Cadastrar~~' 0
(~~0 1
contato~~1 8
)~~8 9
;~~9 :
return 
Ok 
( 
contato %
)% &
;& '
}
€€ 
else
 
{
‚‚ 
return
ƒƒ 

BadRequest
ƒƒ %
(
ƒƒ% &

ModelState
ƒƒ& 0
)
ƒƒ0 1
;
ƒƒ1 2
}
„„ 
}
…… 
catch
†† 
(
†† 
	Exception
†† 
e
†† 
)
†† 
{
‡‡ 
return
ˆˆ 

BadRequest
ˆˆ !
(
ˆˆ! "
e
ˆˆ" #
)
ˆˆ# $
;
ˆˆ$ %
}
‰‰ 
}
‹‹ 	
[
¡¡ 	
	Authorize
¡¡	 
]
¡¡ 
[
¢¢ 	
HttpPut
¢¢	 
]
¢¢ 
public
££ 
IActionResult
££ 
Put
££  
(
££  !
[
££! "
FromBody
££" *
]
££* + 
ContatoUpdateInput
££, >
input
££? D
)
££D E
{
¤¤ 	
try
¥¥ 
{
¦¦ 
if
§§ 
(
§§ 

ModelState
§§ 
.
§§ 
IsValid
§§ &
)
§§& '
{
¨¨ 
var
©© 
contato
©© 
=
©©  ! 
_contatoRepository
©©" 4
.
©©4 5

ObterPorId
©©5 ?
(
©©? @
input
©©@ E
.
©©E F
Id
©©F H
)
©©H I
;
©©I J
contato
ªª 
.
ªª 
Nome
ªª  
=
ªª! "
input
ªª# (
.
ªª( )
Nome
ªª) -
;
ªª- .
contato
«« 
.
«« 
DDD
«« 
=
««  !
input
««" '
.
««' (
DDD
««( +
;
««+ ,
contato
¬¬ 
.
¬¬ 
Telefone
¬¬ $
=
¬¬% &
Convert
¬¬' .
.
¬¬. /
ToInt32
¬¬/ 6
(
¬¬6 7
input
¬¬7 <
.
¬¬< =
Telefone
¬¬= E
)
¬¬E F
;
¬¬F G
contato
­­ 
.
­­ 
Email
­­ !
=
­­" #
input
­­$ )
.
­­) *
Email
­­* /
;
­­/ 0 
_contatoRepository
®® &
.
®®& '
Alterar
®®' .
(
®®. /
contato
®®/ 6
)
®®6 7
;
®®7 8
return
¯¯ 
Ok
¯¯ 
(
¯¯ 
input
¯¯ #
)
¯¯# $
;
¯¯$ %
}
°° 
else
±± 
{
²² 
return
³³ 

BadRequest
³³ %
(
³³% &

ModelState
³³& 0
)
³³0 1
;
³³1 2
}
´´ 
}
µµ 
catch
¶¶ 
(
¶¶ 
	Exception
¶¶ 
e
¶¶ 
)
¶¶ 
{
·· 
return
¸¸ 

BadRequest
¸¸ !
(
¸¸! "
e
¸¸" #
)
¸¸# $
;
¸¸$ %
}
¹¹ 
}
ºº 	
[
ÄÄ 	
	Authorize
ÄÄ	 
]
ÄÄ 
[
ÅÅ 	

HttpDelete
ÅÅ	 
(
ÅÅ 
$str
ÅÅ 
)
ÅÅ 
]
ÅÅ  
public
ÆÆ 
IActionResult
ÆÆ 
Delete
ÆÆ #
(
ÆÆ# $
[
ÆÆ$ %
	FromRoute
ÆÆ% .
]
ÆÆ. /
int
ÆÆ0 3
id
ÆÆ4 6
)
ÆÆ6 7
{
ÇÇ 	
try
ÈÈ 
{
ÉÉ  
_contatoRepository
ÊÊ "
.
ÊÊ" #
Deletar
ÊÊ# *
(
ÊÊ* +
id
ÊÊ+ -
)
ÊÊ- .
;
ÊÊ. /
return
ËË 
Ok
ËË 
(
ËË 
)
ËË 
;
ËË 
}
ÌÌ 
catch
ÍÍ 
(
ÍÍ 
	Exception
ÍÍ 
e
ÍÍ 
)
ÍÍ 
{
ÎÎ 
return
ÏÏ 

BadRequest
ÏÏ !
(
ÏÏ! "
e
ÏÏ" #
)
ÏÏ# $
;
ÏÏ$ %
}
ÐÐ 
}
ÑÑ 	
}
ÓÓ 
}ÔÔ 